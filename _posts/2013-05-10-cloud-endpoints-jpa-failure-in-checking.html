---
layout: post
comments: true
title: 'Cloud Endpoints + JPA: failure in checking if entity exists'
date: '2013-05-10T01:47:00.000+01:00'
author: Igor Duarte Cardoso
tags:
- Google App Engine
- Development
- Google Cloud Endpoints
- JPA
modified_time: '2013-05-10T01:58:00.588+01:00'
blogger_id: tag:blogger.com,1999:blog-7503515668102711213.post-1815625370288128512
blogger_orig_url: http://igordcard.blogspot.com/2013/05/cloud-endpoints-jpa-failure-in-checking.html
---

<the br="" got.="" i="" intriguing="" last="" problem="" ve="">After defining some entity classes to be used by JPA for persisting data in Google App Engine I auto-generated some Cloud Endpoint classes (for Google Cloud Endpoints), via the Google App Engine SDK, to be used in an Android application. However, it turned out to be a sad out-of-the-box experience due to new entity instances having a null ID.<br /></the><br /><a name='more'></a>Before proceeding, here's the testing entity code (excluding imports):<br /><pre class="prettyprint"><br />@Entity<br />public class Testo {<br /> @Id<br /> @GeneratedValue(strategy = GenerationType.IDENTITY)<br /> private Long ID;<br /> private String description;<br /> <br /> public Long getID() {<br />  return ID;<br /> }<br /> public void setID(Long ID) {<br />  this.ID = ID;<br /> }<br /> public String getDescription() {<br />  return description;<br /> }<br /> public void setDescription(String description) {<br />  this.description = description;<br /> }<br />}<br /><br /></pre>A really simple one.<br /><br />To test the entity and the endpoint classes, I auto-generated the Cloud Endpoint Client Library and made use of it in an Android testing application (Endpoints Backend enabled). The application would only create a new entity, set its attributes to some value, and then request to insert that entity into the datastore, using&nbsp;Google Cloud Endpoints in the middle.<br /><br />After testing it up, though, I got a <b><a href="https://raw.githubusercontent.com/igordcard/igordcard/master/_downloads/trace.txt">big stack trace</a></b> from the Google development server due to a <code>NullPointerException</code> that occurred when checking if that entity existed in the&nbsp;datastore.<br /><br />The exception referred to the fact that no entity ID was set. So, if new entities don't have an ID, how can they be checked for existence requiring a valid ID?<br /><br /><b>The point of failure</b><br />(at least in my specific case)<br /><br />The endpoint class <code>TestoEndpoint.java</code>, auto-generated method: <code>containsTesto(Testo testo)</code>: <br /><pre class="prettyprint">private boolean containsTesto(Testo testo) {<br /> EntityManager mgr = getEntityManager(); <br /> boolean contains = true;<br /> try {<br />  Testo item = mgr.find(Testo.class, testo.getID());<br />  if (item == null) {<br />   contains = false;<br />  }<br /> } finally {<br />  mgr.close();<br /> }<br /> return contains;<br />}<br /></pre><br />This method makes use of the Entity Manager's find() method, which in this context takes a null ID and crashes, not even being able to tell if the datastore contains or not that entity.<br /><br /><b>What I changed</b><br /><br />To work around this annoying problem I added a <code>null</code> check for the entity argument: <br /><pre class="prettyprint"><br />private boolean containsTesto(Testo testo) {<br /> EntityManager mgr = getEntityManager(); <br /> boolean contains = true;<br /> try {<br />  <b>// If no ID was set, the entity doesn't exist yet.<br />  if(testo.getID() == null)<br />   return false;</b><br />  Testo item = mgr.find(Testo.class, testo.getID());<br />  if (item == null) {<br />   contains = false;<br />  }<br /> } finally {<br />  mgr.close();<br /> }<br /> return contains;<br />}<br /></pre><b><br /></b><b>Some links:</b> <br /><br /><ul><li><a href="https://developers.google.com/appengine/">Google App Engine</a></li><li><a href="https://developers.google.com/appengine/docs/java/endpoints/">Google Cloud Endpoints</a></li><li><a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">JPA</a></li><li><a href="https://developers.google.com/eclipse/docs/endpoints-androidconnected-gae">Creating an App Engine Connected Android Project</a></li><li><a href="http://stackoverflow.com/questions/15226793/nullpointerexception-throws-when-inserting-entity-using-auto-generated-classendp">This developer has exactly the same problem</a></li></ul>

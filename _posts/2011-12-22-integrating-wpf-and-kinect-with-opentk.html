---
layout: post
comments: true
title: Integrating WPF and Microsoft Kinect SDK with OpenTK
date: '2011-12-22T15:20:00.001Z'
author: Igor Duarte Cardoso
tags:
- WPF
- OpenTK
- Kinect
- Microsoft
modified_time: '2012-02-10T22:36:13.467Z'
thumbnail: http://3.bp.blogspot.com/-puQmS7VOZfE/TvNxzlD_PdI/AAAAAAAAAJU/9Y5AJqHheAQ/s72-c/new-project.png
blogger_id: tag:blogger.com,1999:blog-7503515668102711213.post-4117778612237182737
blogger_orig_url: http://igordcard.blogspot.com/2011/12/integrating-wpf-and-kinect-with-opentk.html
---

Well, this is my first post, so I'm gonna make it a simple (yet not so short) one.<br /><br />If you have started messing around with <b>OpenTK</b> recently and also do not have much experience with <b>.NET</b>, this might help you. This is especially true if you want to use <b>WPF</b> (Windows Presentation Foundation) instead of Windows Forms for rendering <b>OpenGL</b> graphics through OpenTK. And if, on top of that, you also intend on using <b>Microsoft Kinect SDK</b>, then this is the right post.<br /><br /><br /><a name='more'></a>Using Kinect and OpenGL simultaneously gives us a really wide range of possibilities, for instance real time rendering of the 3D space captured by Kinect (plus texture). One way of obtaining that is having access to both Kinect and OpenTK's data and events, in the same application.<br /><br />For this post, I will just focus on how to have a simple application that can render OpenTK graphics and present video from Kinect, in the same window.<br /><br />Well, let's start then:<br /><br />1. Create a new WPF Application project and rename the <code class="prettyprint">MainWindow Grid</code> to <code class="prettyprint">grid</code>. <br /><div class="separator" style="clear: both; text-align: center;"><a imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="442" src="/assets/new-project.png" width="640" /></a></div><br />2. Add references in the project to:<br /><ul><li><code class="prettyprint">System.Windows.Forms</code></li><li><code class="prettyprint">WindowsFormsIntegration</code></li><li><code class="prettyprint">OpenTK</code></li><li><code class="prettyprint">OpenTK.GLControl</code></li><li><code class="prettyprint">System.Drawing</code> (to ease the use of colors in OpenTK)</li><li><code class="prettyprint">Microsoft.Research.Kinect</code> (to use the Kinect device)</li></ul><br /><div class="separator" style="clear: both; text-align: center;"><a imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="287" src="/assets/references.png" width="236" /></a></div><br />3. Open the WPF Designer and add the following namespace mapping (in the source code area) to the Window element:<br /><code class="prettyprint">xmlns:wf="clr-namespace:System.Windows.Forms;assembly=System.Windows.Forms"</code><br /><br />Then, add an <code class="prettyprint">Image</code> element (just to show Kinect video stream) called <code class="prettyprint">image</code> and a <code class="prettyprint">WindowsFormsHost</code> element called <code class="prettyprint">host</code>, both inside the <code class="prettyprint">Grid</code> element, side by side. Set an event for when the <code class="prettyprint">Window</code> element is Loaded. It should look something like this: <br /><pre class="prettyprint">&lt;Window x:Class="WpfApplication1.MainWindow"<br />        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"<br />        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"<br />        xmlns:wf="clr-namespace:System.Windows.Forms;assembly=System.Windows.Forms"<br />        Title="MainWindow" Height="375" Width="1000" Loaded="Window_Loaded"&gt;<br />    &lt;Grid Name="grid"&gt;<br />        &lt;Image Width="500" Height="375" Name="image" HorizontalAlignment="Left" /&gt;<br />        &lt;WindowsFormsHost Width="500" Height="375" Name="host" HorizontalAlignment="Right" /&gt;<br />    &lt;/Grid&gt;<br />&lt;/Window&gt;<br /></pre><br />4. In the .cs include the following types:<br /><br /><code class="prettyprint">using System.Windows.Forms;<br />using OpenTK;<br />using OpenTK.Graphics;<br />using OpenTK.Graphics.OpenGL;<br />using Microsoft.Research.Kinect.Nui;</code><br /><br />5. Make the <code class="prettyprint">Window</code> element <code class="prettyprint">Loaded</code> event handler look like this:<br /><pre class="prettyprint">        private void Window_Loaded(object sender, RoutedEventArgs e)<br />        {<br />            // Create the GLControl.<br />            glc = new GLControl();<br /><br />            // Assign the GLControl as the host control's child.<br />            host.Child = glc;<br />        }<br /></pre><br />You are now creating an instance of <code class="prettyprint">GLControl</code> and associating it with <code class="prettyprint">host</code> (the <code class="prettyprint">WindowsFormsHost</code> element you added) by making <code class="prettyprint">glc</code> its child.<br /><br />6. Next is assigning events <code class="prettyprint">Load</code> and <code class="prettyprint">Paint</code> of <code class="prettyprint">GLControl</code> to two new event handlers (you can double press Tab key to automatically create an event handler body, after the <code class="prettyprint">+=</code> sign): <br /><pre class="prettyprint">        private void Window_Loaded(object sender, RoutedEventArgs e)<br />        {<br />            // Create the GLControl.<br />            glc = new GLControl();<br /><br />            // Assign Load and Paint events of GLControl.<br />            glc.Load += new EventHandler(glc_Load);<br />            glc.Paint += new System.Windows.Forms.PaintEventHandler(glc_Paint);<br /><br />            // Assign the GLControl as the host control's child.<br />            host.Child = glc;<br />        }<br /><br />        void glc_Paint(object sender, System.Windows.Forms.PaintEventArgs e)<br />        {<br />            throw new NotImplementedException();<br />        }<br /><br />        void glc_Load(object sender, EventArgs e)<br />        {<br />            throw new NotImplementedException();<br />        }<br /></pre><br />7. Now fill <code class="prettyprint">Load</code> and <code class="prettyprint">Paint</code> event handlers with an initial OpenGL configuration (viewport, etc) and what should be drawn every time the control needs a repaint, respectively. The result can be something like:<br /><pre class="prettyprint">        void glc_Load(object sender, EventArgs e)<br />        {<br />            // Make background "chocolate"<br />            GL.ClearColor(System.Drawing.Color.Chocolate);<br /><br />            int w = glc.Width;<br />            int h = glc.Height;<br /><br />            // Set up initial modes<br />            GL.MatrixMode(MatrixMode.Projection);<br />            GL.LoadIdentity();<br />            GL.Ortho(0, w, 0, h, -1, 1);<br />            GL.Viewport(0, 0, w, h);<br />        }<br /></pre><pre class="prettyprint">        void glc_Paint(object sender, System.Windows.Forms.PaintEventArgs e)<br />        {<br />            GL.Clear(ClearBufferMask.ColorBufferBit | ClearBufferMask.DepthBufferBit);<br /><br />            GL.MatrixMode(MatrixMode.Modelview);<br />            GL.LoadIdentity();<br /><br />            // Draw a little yellow triangle<br />            GL.Color3(System.Drawing.Color.Yellow);<br />            GL.Begin(BeginMode.Triangles);<br />            GL.Vertex2(200, 50);<br />            GL.Vertex2(200, 200);<br />            GL.Vertex2(100, 50);<br />            GL.End();<br /><br />            glc.SwapBuffers();<br />        }<br /></pre><br />Build and run it. If you (or me) haven't forgot something, it should be working and showing a little yellow triangle inside the WPF Grid.<br /><br />8. Now, we want to have access to Kinect data, in real time.<br />You added a reference to <code class="prettyprint">Microsoft.Research.Kinect</code> and did <code class="prettyprint">using Microsoft.Research.Kinect.Nui;</code> in the beginning of this post, like you'd do with a normal Kinect project (it's exactly the same, now that we have finished integrating OpenTK), so now it's time to get Kinect ready.<br />Create a <code class="prettyprint">Runtime</code> instance in the class definition, initiate it and assign the required events in the Window Loaded event. <br /><pre class="prettyprint">            // Initiate Kinect runtime and streams<br />            nui = Runtime.Kinects[0];<br />            try<br />            {<br />                nui.Initialize(RuntimeOptions.UseColor);<br />                nui.VideoStream.Open(ImageStreamType.Video, 2,<br />                    ImageResolution.Resolution640x480, ImageType.Color);<br />            }<br />            catch (InvalidOperationException)<br />            {<br />                return;<br />            }<br />            // Assign stream events<br />            nui.VideoFrameReady += new EventHandler<imageframereadyeventargs>(nui_VideoFrameReady);<br /></imageframereadyeventargs><br /></pre><br />9. Fill the video stream ready event handler to just dump the stream to the <code class="prettyprint">Image</code> element we previously created.<br /><pre class="prettyprint">        public void nui_VideoFrameReady(object sender, ImageFrameReadyEventArgs e)<br />        {<br />            PlanarImage Image = e.ImageFrame.Image;<br />            image.Source = BitmapSource.Create(Image.Width, Image.Height, 96, 96,<br />                PixelFormats.Bgr32, null, Image.Bits, Image.Width * Image.BytesPerPixel);<br />        }<br /></pre>Build and run, hopefully you'll see a window showing the Kinect video stream and an OpenGL rendering via OpenTK, both throwing and handling whatever events you register to them.<br /><br />Full source code: <a href="http://igordcard.googlecode.com/files/kinect-opentk-1.0.zip">Download here</a>.<br /><br />Everything I explained here has already been done on other sources. I've just put things together for a simple way of integrating Kinect (and WPF) with OpenTK (OpenGL in .NET). All source code has been tested on OpenTK 1.0 and Microsoft Kinect SDK beta 2.<br /><br />For more information, check the following references:<br /><a href="http://www.opentk.com/doc/chapter/2/glcontrol">Building a Windows.Forms + GLControl based application</a><br /><a href="http://msdn.microsoft.com/en-us/library/ms742875.aspx">Hosting a Windows Forms Control in WPF by Using XAML</a><br /><a href="http://msdn.microsoft.com/en-us/library/wkze6zky%28v=vs.80%29.aspx">Add or Remove References in Visual Studio</a><br /><div class="separator" style="clear: both; text-align: center;"></div>